<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>API Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1G8qonJ8aFOBvawt1yXQXg6"
      crossorigin="anonymous"
    >
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1B7e1Z3s2L4LhOUCFpC/6pP9Gfj5wla3V7R5M1F2xZJ1Ao0P5PLf4psJ3A2w3R0F0A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    >
    <style>
      :root {
        --crypto-grad: linear-gradient(135deg, #0f766e, #fbbf24);
        --weather-grad: linear-gradient(135deg, #38bdf8, #fde68a);
        --news-grad: linear-gradient(135deg, #1e293b, #0f172a);
      }

      .card-section {
        border: 0;
        border-radius: 1rem;
        box-shadow: 0 12px 30px -12px rgba(15, 23, 42, 0.35);
        color: #0f172a;
        min-height: 100%;
        overflow: hidden;
      }

      .card-section[data-theme="crypto"] .card-header {
        background: var(--crypto-grad);
        color: #0f172a;
      }

      .card-section[data-theme="weather"] .card-header {
        background: var(--weather-grad);
        color: #0f172a;
      }

      .card-section[data-theme="news"] .card-header {
        background: var(--news-grad);
        color: #e2e8f0;
      }

      .card-header {
        border: 0;
        padding: 1.5rem;
      }

      .card-icon {
        font-size: 2rem;
        margin-right: 0.75rem;
      }

      .card-title {
        font-size: 1.15rem;
        margin: 0;
      }

      .card-body {
        padding: 1.75rem 1.5rem;
        background: rgba(255, 255, 255, 0.82);
      }

      .btn-refresh {
        border-radius: 999px;
        transition: transform 180ms ease, box-shadow 180ms ease;
      }

      .btn-refresh:hover,
      .btn-refresh:focus-visible {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px -8px rgba(59, 130, 246, 0.6);
      }

      .btn-refresh:disabled {
        opacity: 0.7;
      }

      @media (max-width: 576px) {
        .card-body {
          padding: 1.5rem;
        }

        .display-5 {
          font-size: 2rem;
        }
      }
    </style>
  </head>
  <body class="bg-light d-flex flex-column min-vh-100">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
      <div class="container py-2">
        <a class="navbar-brand fw-semibold" href="#">API Dashboard</a>
      </div>
    </nav>

    <main class="container flex-grow-1 py-5">
      <div class="text-center mb-5">
        <h1 class="display-5 fw-bold text-dark">API Dashboard</h1>
        <p class="text-muted mb-0">
          Monitor cryptocurrencies, weather, and headlines side-by-side.
        </p>
      </div>

      <div class="row g-4 justify-content-center">
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card card-section h-100" data-theme="crypto">
            <div class="card-header d-flex align-items-center">
              <span class="card-icon">
                <i class="fa-solid fa-coins"></i>
              </span>
              <h5 class="card-title mb-0">Crypto Prices</h5>
            </div>
            <div class="card-body">
              {% set btc_price = (crypto_prices or {}).get('bitcoin', {}).get('usd') %}
              {% set eth_price = (crypto_prices or {}).get('ethereum', {}).get('usd') %}
              {% set formatted_updated = crypto_last_updated.strftime('%Y-%m-%d %H:%M:%S UTC') if crypto_last_updated else None %}

              <div class="mb-4">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <p class="text-uppercase small text-muted mb-1">Bitcoin</p>
                    <p class="fs-3 fw-semibold text-dark mb-0" id="crypto-price-btc">
                      {% if btc_price is not none %}
                      ${{ '%.2f'|format(btc_price) }}
                      {% else %}
                      N/A
                      {% endif %}
                    </p>
                  </div>
                  <i class="fa-brands fa-bitcoin text-warning fs-2"></i>
                </div>
                <hr class="my-4 opacity-25">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <p class="text-uppercase small text-muted mb-1">Ethereum</p>
                    <p class="fs-4 fw-semibold text-dark mb-0" id="crypto-price-eth">
                      {% if eth_price is not none %}
                      ${{ '%.2f'|format(eth_price) }}
                      {% else %}
                      N/A
                      {% endif %}
                    </p>
                  </div>
                  <i class="fa-brands fa-ethereum text-secondary fs-2"></i>
                </div>
              </div>

              <p class="text-muted small mb-3" id="crypto-last-updated">
                {% if formatted_updated %}
                Last updated {{ formatted_updated }}
                {% else %}
                Last updated: unavailable
                {% endif %}
              </p>

              <button
                type="button"
                class="btn btn-sm btn-outline-primary btn-refresh"
                data-refresh-endpoint="{{ url_for('crypto.crypto') }}"
                data-refresh-type="crypto"
              >
                Refresh
              </button>
            </div>
          </div>
        </div>

        <div class="col-12 col-md-6 col-lg-4">
          <div class="card card-section h-100" data-theme="weather">
            <div class="card-header d-flex align-items-center">
              <span class="card-icon">
                <i class="fa-solid fa-cloud-sun"></i>
              </span>
              <h5 class="card-title mb-0">Weather Forecast</h5>
            </div>
            <div class="card-body">
              {% set temp = (weather_data or {}).get('main', {}).get('temp') if weather_data else None %}
              {% set humidity = (weather_data or {}).get('main', {}).get('humidity') if weather_data else None %}
              {% set wind = (weather_data or {}).get('wind', {}).get('speed') if weather_data else None %}
              {% set condition = ((weather_data or {}).get('weather') or [{}])[0].get('description') if weather_data else None %}
              {% set weather_city = (weather_data or {}).get('name') if weather_data else None %}
              {% set weather_updated = weather_last_updated.strftime('%Y-%m-%d %H:%M:%S UTC') if weather_last_updated else None %}

              <div class="d-flex align-items-center justify-content-between mb-4">
                <div>
                  <p class="text-uppercase small text-muted mb-1" id="weather-city">
                    {{ weather_city or 'Chicago' }}
                  </p>
                  <p class="display-5 fw-semibold text-dark mb-2" id="weather-temperature">
                    {% if temp is not none %}
                    {{ '%.0f'|format(temp) }}&deg;F
                    {% else %}
                    N/A
                    {% endif %}
                  </p>
                  <p class="fs-6 text-muted mb-0 text-capitalize" id="weather-condition">
                    {% if condition %}
                    {{ condition }}
                    {% else %}
                    Condition unavailable
                    {% endif %}
                  </p>
                </div>
                <div class="fs-1" aria-hidden="true">üå§Ô∏è</div>
              </div>

              <div class="d-flex justify-content-between text-muted mb-3 small">
                <span id="weather-humidity">
                  Humidity:
                  {% if humidity is not none %}
                  {{ humidity }}%
                  {% else %}
                  N/A
                  {% endif %}
                </span>
                <span id="weather-wind">
                  Wind:
                  {% if wind is not none %}
                  {{ '%.1f'|format(wind) }} mph
                  {% else %}
                  N/A
                  {% endif %}
                </span>
              </div>

              <p class="text-muted small mb-3" id="weather-last-updated">
                {% if weather_updated %}
                Last updated {{ weather_updated }}
                {% else %}
                Last updated: unavailable
                {% endif %}
              </p>

              <button
                type="button"
                class="btn btn-sm btn-outline-primary btn-refresh"
                data-refresh-endpoint="{{ url_for('weather.weather') }}"
                data-refresh-type="weather"
              >
                Refresh
              </button>
            </div>
          </div>
        </div>

        <div class="col-12 col-md-6 col-lg-4">
          <div class="card card-section h-100" data-theme="news">
            <div class="card-header d-flex align-items-center">
              <span class="card-icon">
                <i class="fa-solid fa-newspaper"></i>
              </span>
              <h5 class="card-title mb-0">News Headlines</h5>
            </div>
            <div class="card-body">
              <p class="card-text text-muted mb-4">Loading data...</p>
              <button type="button" class="btn btn-sm btn-outline-primary btn-refresh" disabled>
                Refresh
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer class="bg-dark text-white-50 py-3">
      <div class="container text-center small">
        &copy; API Dashboard ¬∑ Built with Flask &amp; Bootstrap
      </div>
    </footer>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const buttons = document.querySelectorAll("[data-refresh-endpoint]");
        if (!buttons.length) return;

        const formatCurrency = (value) =>
          new Intl.NumberFormat("en-US", {
            style: "currency",
            currency: "USD",
            maximumFractionDigits: 2,
          }).format(value);

        const formatTimestamp = (value) => {
          const date = value ? new Date(value) : new Date();
          return new Intl.DateTimeFormat("en-US", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            hour12: false,
            timeZoneName: "short",
          }).format(date);
        };

        const updaters = {
          crypto: (payload) => {
            const btcPriceEl = document.getElementById("crypto-price-btc");
            const ethPriceEl = document.getElementById("crypto-price-eth");
            const updatedEl = document.getElementById("crypto-last-updated");
            const btc = payload?.bitcoin?.usd;
            const eth = payload?.ethereum?.usd;

            if (btcPriceEl) {
              btcPriceEl.textContent =
                typeof btc === "number" ? formatCurrency(btc) : "N/A";
            }
            if (ethPriceEl) {
              ethPriceEl.textContent =
                typeof eth === "number" ? formatCurrency(eth) : "N/A";
            }
            if (updatedEl) {
              updatedEl.textContent = `Last updated ${formatTimestamp(
                payload?.last_updated
              )}`;
            }
          },
          weather: (payload) => {
            const cityEl = document.getElementById("weather-city");
            const tempEl = document.getElementById("weather-temperature");
            const conditionEl = document.getElementById("weather-condition");
            const humidityEl = document.getElementById("weather-humidity");
            const windEl = document.getElementById("weather-wind");
            const updatedEl = document.getElementById("weather-last-updated");

            const temperature = payload?.temperature;
            const condition = payload?.condition;
            const humidity = payload?.humidity;
            const windSpeed = payload?.wind_speed;
            const city = payload?.city;

            if (cityEl && city) {
              cityEl.textContent = city;
            }

            if (tempEl) {
              tempEl.textContent =
                typeof temperature === "number"
                  ? `${Math.round(temperature)}${String.fromCharCode(176)}F`
                  : "N/A";
            }

            if (conditionEl) {
              const formattedCondition = (() => {
                if (!condition) return "";
                const text = String(condition).trim();
                return text
                  .split(" ")
                  .map((word) =>
                    word ? word[0].toUpperCase() + word.slice(1).toLowerCase() : ""
                  )
                  .join(" ");
              })();
              conditionEl.textContent =
                formattedCondition || "Condition unavailable";
            }

            if (humidityEl) {
              humidityEl.textContent =
                typeof humidity === "number"
                  ? `Humidity: ${humidity}%`
                  : "Humidity: N/A";
            }

            if (windEl) {
              windEl.textContent =
                typeof windSpeed === "number"
                  ? `Wind: ${windSpeed.toFixed(1)} mph`
                  : "Wind: N/A";
            }

            if (updatedEl) {
              updatedEl.textContent = `Last updated ${formatTimestamp(
                payload?.last_updated
              )}`;
            }
          },
        };

        buttons.forEach((button) => {
          const endpoint = button.dataset.refreshEndpoint;
          const type = button.dataset.refreshType;
          if (!endpoint || !type || !(type in updaters)) return;

          button.addEventListener("click", async () => {
            button.disabled = true;
            button.classList.add("disabled");

            try {
              const response = await fetch(endpoint, { cache: "no-store" });
              if (!response.ok) {
                throw new Error(`Request failed: ${response.status}`);
              }
              const payload = await response.json();
              updaters[type](payload);
            } catch (error) {
              console.error(`Failed to refresh ${type} data:`, error);
              const updatedEl =
                type === "crypto"
                  ? document.getElementById("crypto-last-updated")
                  : document.getElementById("weather-last-updated");
              if (updatedEl) {
                updatedEl.textContent =
                  "Last updated: unable to refresh at this time.";
              }
            } finally {
              button.disabled = false;
              button.classList.remove("disabled");
            }
          });
        });
      });
    </script>
  </body>
</html>
