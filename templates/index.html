<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>API Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1G8qonJ8aFOBvawt1yXQXg6"
      crossorigin="anonymous"
    >
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1B7e1Z3s2L4LhOUCFpC/6pP9Gfj5wla3V7R5M1F2xZJ1Ao0P5PLf4psJ3A2w3R0F0A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    >
    <style>
      :root {
        --crypto-grad: linear-gradient(135deg, #0f766e, #fbbf24);
        --weather-grad: linear-gradient(135deg, #38bdf8, #fde68a);
        --news-grad: linear-gradient(135deg, #1e293b, #0f172a);
      }

      .card-section {
        border: 1px solid transparent;
        border-radius: 1rem;
        box-shadow: 0 12px 30px -12px rgba(15, 23, 42, 0.35);
        color: #0f172a;
        min-height: 100%;
        overflow: hidden;
        position: relative;
        transition: box-shadow 0.35s ease, border-color 0.35s ease;
      }

      .card-refresh-overlay {
        position: absolute;
        inset: 0;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.5s ease;
        z-index: 5;
      }

      .card-section.is-refreshing .card-refresh-overlay {
        opacity: 1;
        pointer-events: all;
      }

      .card-section.flash-success {
        border-color: rgba(34, 197, 94, 0.75);
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.45);
        animation: card-glow-success 0.8s ease;
      }

      .card-section.flash-error {
        border-color: rgba(239, 68, 68, 0.8);
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.45);
        animation: card-glow-error 0.8s ease;
      }

      @keyframes card-glow-success {
        0% {
          box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
        }
        40% {
          box-shadow: 0 0 18px 6px rgba(34, 197, 94, 0.4);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
        }
      }

      @keyframes card-glow-error {
        0% {
          box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
        }
        40% {
          box-shadow: 0 0 18px 6px rgba(239, 68, 68, 0.35);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
        }
      }

      .timestamp-text {
        transition: color 0.4s ease;
      }

      .timestamp-flash {
        animation: timestampPulse 0.9s ease;
      }

      @keyframes timestampPulse {
        0% {
          color: #64748b;
        }
        40% {
          color: #0f172a;
        }
        100% {
          color: #64748b;
        }
      }

      .refresh-toast {
        border: 0;
        border-radius: 0.75rem;
        color: #f8fafc;
        font-weight: 600;
        min-width: 240px;
        padding: 0;
      }

      .refresh-toast .toast-body {
        align-items: center;
        display: flex;
        gap: 0.75rem;
        justify-content: space-between;
        padding: 0.9rem 1rem;
      }

      .refresh-toast .toast-label {
        font-size: 0.8rem;
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }

      .refresh-toast.toast-crypto {
        background-color: #0f766e;
      }

      .refresh-toast.toast-weather {
        background-color: #1d4ed8;
      }

      .refresh-toast.toast-news {
        background-color: #1e293b;
      }

      .refresh-toast.toast-error {
        background-color: #dc2626;
      }

      .card-section[data-theme="crypto"] .card-header {
        background: var(--crypto-grad);
        color: #0f172a;
      }

      .card-section[data-theme="weather"] .card-header {
        background: var(--weather-grad);
        color: #0f172a;
      }

      .card-section[data-theme="news"] .card-header {
        background: var(--news-grad);
        color: #e2e8f0;
      }

      .card-header {
        border: 0;
        padding: 1.5rem;
      }

      .card-icon {
        font-size: 2rem;
        margin-right: 0.75rem;
      }

      .card-title {
        font-size: 1.15rem;
        margin: 0;
      }

      .card-body {
        padding: 1.75rem 1.5rem;
        background: rgba(255, 255, 255, 0.82);
      }

      .news-headlines {
        display: grid;
        gap: 1rem;
      }

      .news-headline-item {
        border-bottom: 1px solid rgba(148, 163, 184, 0.35);
        padding-bottom: 0.75rem;
      }

      .news-headline-item:last-child {
        border-bottom: 0;
        padding-bottom: 0;
      }

      .news-headline-link {
        color: #0f172a;
        font-weight: 600;
        text-decoration: none;
        word-break: break-word;
      }

      .news-headline-link:hover,
      .news-headline-link:focus-visible {
        color: #1d4ed8;
        text-decoration: underline;
      }

      .news-headline-meta {
        color: #64748b;
        font-size: 0.85rem;
        margin-top: 0.35rem;
        word-break: break-word;
      }

      .news-headline-description {
        color: #475569;
        font-size: 0.9rem;
        margin-top: 0.5rem;
        word-break: break-word;
      }

      .btn-refresh {
        border-radius: 999px;
        transition: transform 180ms ease, box-shadow 180ms ease;
      }

      .btn-refresh:hover,
      .btn-refresh:focus-visible {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px -8px rgba(59, 130, 246, 0.6);
      }

      .btn-refresh:disabled {
        opacity: 0.7;
      }

      @media (max-width: 576px) {
        .card-body {
          padding: 1.5rem;
        }

        .display-5 {
          font-size: 2rem;
        }
      }
    </style>
  </head>
  <body
    class="bg-light d-flex flex-column min-vh-100"
    data-auto-refresh-interval="{{ auto_refresh_minutes }}"
  >
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
      <div class="container py-2 d-flex align-items-center gap-3">
        <a class="navbar-brand fw-semibold mb-0" href="{{ url_for('main.index') }}">API Dashboard</a>
        <div class="d-flex align-items-center gap-3 ms-auto">
          {% if current_user.is_authenticated %}
            <div class="text-white-50 small me-2 d-none d-md-flex align-items-center gap-2">
              <i class="fa-solid fa-user-circle"></i>
              <span>{{ current_user.email }}</span>
            </div>
          {% endif %}
          <a
            class="btn btn-sm btn-outline-light"
            href="{{ url_for('main.settings') }}"
          >
            Settings
          </a>
          <div class="form-check form-switch text-white-50 small mb-0">
            <input
              class="form-check-input"
              type="checkbox"
              role="switch"
              id="auto-refresh-toggle"
            >
            <label class="form-check-label ms-2" for="auto-refresh-toggle">
              Auto refresh
            </label>
          </div>
          {% if current_user.is_authenticated %}
            <a class="btn btn-sm btn-outline-light" href="{{ url_for('auth.logout') }}">
              Logout
            </a>
          {% endif %}
        </div>
      </div>
    </nav>

    <main class="container flex-grow-1 py-5">
      <div class="text-center mb-5">
        <h1 class="display-5 fw-bold text-dark">API Dashboard</h1>
        <p class="text-muted mb-0">
          Monitor cryptocurrencies, weather, and headlines side-by-side.
        </p>
      </div>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="row justify-content-center mb-4">
            <div class="col-12 col-lg-8">
              {% for category, message in messages %}
                <div class="alert alert-{{ category }} mb-2" role="alert">
                  {{ message }}
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}
      {% endwith %}
      <div class="row g-4 justify-content-center">
        {% if show_crypto %}
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card card-section h-100" data-theme="crypto">
            <div
              class="card-refresh-overlay fade d-flex align-items-center justify-content-center bg-white bg-opacity-75"
            >
              <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
              <span class="visually-hidden">Refreshing</span>
            </div>
            <div class="card-header d-flex align-items-center">
              <span class="card-icon">
                <i class="fa-solid fa-coins"></i>
              </span>
              <h5 class="card-title mb-0">Crypto Prices</h5>
            </div>
            <div class="card-body">
              {% set btc_price = (crypto_prices or {}).get('bitcoin', {}).get('usd') %}
              {% set eth_price = (crypto_prices or {}).get('ethereum', {}).get('usd') %}
              {% set formatted_updated = crypto_last_updated.strftime('%Y-%m-%d %H:%M:%S UTC') if crypto_last_updated else None %}

              <div class="mb-4">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <p class="text-uppercase small text-muted mb-1">Bitcoin</p>
                    <p class="fs-3 fw-semibold text-dark mb-0" id="crypto-price-btc">
                      {% if btc_price is not none %}
                      ${{ '%.2f'|format(btc_price) }}
                      {% else %}
                      N/A
                      {% endif %}
                    </p>
                  </div>
                  <i class="fa-brands fa-bitcoin text-warning fs-2"></i>
                </div>
                <hr class="my-4 opacity-25">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <p class="text-uppercase small text-muted mb-1">Ethereum</p>
                    <p class="fs-4 fw-semibold text-dark mb-0" id="crypto-price-eth">
                      {% if eth_price is not none %}
                      ${{ '%.2f'|format(eth_price) }}
                      {% else %}
                      N/A
                      {% endif %}
                    </p>
                  </div>
                  <i class="fa-brands fa-ethereum text-secondary fs-2"></i>
                </div>
              </div>

              <p class="text-muted small mb-3 timestamp-text" id="crypto-last-updated">
                {% if formatted_updated %}
                Last updated {{ formatted_updated }}
                {% else %}
                Last updated: unavailable
                {% endif %}
              </p>

              <button
                type="button"
                class="btn btn-sm btn-outline-primary btn-refresh"
                data-refresh-endpoint="{{ url_for('crypto.crypto') }}"
                data-refresh-type="crypto"
              >
                Refresh
              </button>
            </div>
          </div>
        </div>
        {% endif %}

        {% if show_weather %}
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card card-section h-100" data-theme="weather">
            <div
              class="card-refresh-overlay fade d-flex align-items-center justify-content-center bg-white bg-opacity-75"
            >
              <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
              <span class="visually-hidden">Refreshing</span>
            </div>
            <div class="card-header d-flex align-items-center">
              <span class="card-icon">
                <i class="fa-solid fa-cloud-sun"></i>
              </span>
              <h5 class="card-title mb-0">Weather Forecast</h5>
            </div>
            <div class="card-body">
              {% set temp = (weather_data or {}).get('main', {}).get('temp') if weather_data else None %}
              {% set humidity = (weather_data or {}).get('main', {}).get('humidity') if weather_data else None %}
              {% set wind = (weather_data or {}).get('wind', {}).get('speed') if weather_data else None %}
              {% set condition = ((weather_data or {}).get('weather') or [{}])[0].get('description') if weather_data else None %}
              {% set weather_city = (weather_data or {}).get('name') if weather_data else None %}
              {% set weather_updated = weather_last_updated.strftime('%Y-%m-%d %H:%M:%S UTC') if weather_last_updated else None %}

              <div class="d-flex align-items-center justify-content-between mb-4">
                <div>
                  <p class="text-uppercase small text-muted mb-1" id="weather-city">
                    {{ weather_city or default_city }}
                  </p>
                  <p class="display-5 fw-semibold text-dark mb-2" id="weather-temperature">
                    {% if temp is not none %}
                    {{ '%.0f'|format(temp) }}&deg;F
                    {% else %}
                    N/A
                    {% endif %}
                  </p>
                  <p class="fs-6 text-muted mb-0 text-capitalize" id="weather-condition">
                    {% if condition %}
                    {{ condition }}
                    {% else %}
                    Condition unavailable
                    {% endif %}
                  </p>
                </div>
                <div class="fs-1 text-primary" aria-hidden="true">
                  <i class="fa-solid fa-temperature-half"></i>
                </div>
              </div>

              <div class="d-flex justify-content-between text-muted mb-3 small">
                <span id="weather-humidity">
                  Humidity:
                  {% if humidity is not none %}
                  {{ humidity }}%
                  {% else %}
                  N/A
                  {% endif %}
                </span>
                <span id="weather-wind">
                  Wind:
                  {% if wind is not none %}
                  {{ '%.1f'|format(wind) }} mph
                  {% else %}
                  N/A
                  {% endif %}
                </span>
              </div>

              <p class="text-muted small mb-3 timestamp-text" id="weather-last-updated">
                {% if weather_updated %}
                Last updated {{ weather_updated }}
                {% else %}
                Last updated: unavailable
                {% endif %}
              </p>

              <button
                type="button"
                class="btn btn-sm btn-outline-primary btn-refresh"
                data-refresh-endpoint="{{ url_for('weather.weather') }}"
                data-refresh-type="weather"
              >
                Refresh
              </button>
            </div>
          </div>
        </div>
        {% endif %}

        {% if show_news %}
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card card-section h-100" data-theme="news">
            <div
              class="card-refresh-overlay fade d-flex align-items-center justify-content-center bg-white bg-opacity-75"
            >
              <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
              <span class="visually-hidden">Refreshing</span>
            </div>
            <div class="card-header d-flex align-items-center">
              <span class="card-icon">
                <i class="fa-solid fa-newspaper"></i>
              </span>
              <h5 class="card-title mb-0">News Headlines</h5>
            </div>
            <div class="card-body">
                {% set news_items = (news_headlines or []) %}
                {% set formatted_news_updated = news_last_updated.strftime('%Y-%m-%d %H:%M:%S UTC') if news_last_updated else None %}
                <div class="d-flex flex-column flex-sm-row align-items-sm-center justify-content-between gap-2 mb-3">
                  <small id="news-last-updated" class="text-muted timestamp-text">
                    {% if formatted_news_updated %}
                      Last updated {{ formatted_news_updated }}
                    {% else %}
                      Last updated data unavailable
                    {% endif %}
                  </small>
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-primary btn-refresh ms-sm-auto"
                    data-refresh-endpoint="{{ url_for('news.news') }}"
                    data-refresh-type="news"
                    aria-label="Refresh news headlines"
                  >
                    <i class="fa-solid fa-rotate-right me-1"></i>
                    Refresh
                  </button>
                </div>
                <ul
                  id="news-headlines"
                  class="news-headlines list-unstyled mb-0 {% if not news_items %}d-none{% endif %}"
                >
                  {% for headline in news_items[:5] %}
                    <li class="news-headline-item">
                      <a
                        href="{{ headline.url }}"
                        class="news-headline-link"
                        target="_blank"
                        rel="noopener noreferrer"
                      >
                        {{ headline.title or "Read more" }}
                      </a>
                      {% if headline.source %}
                        <div class="news-headline-meta">{{ headline.source }}</div>
                      {% endif %}
                      {% if headline.description %}
                        <p class="news-headline-description mb-0">
                          {{ headline.description }}
                        </p>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
                <p
                  id="news-empty-state"
                  class="text-muted mb-0 {% if news_items %}d-none{% endif %}"
                >
                  No headlines available right now. Try refreshing in a moment.
                </p>
            </div>
          </div>
        </div>
        {% endif %}

        {% if not (show_crypto or show_weather or show_news) %}
        <div class="col-12">
          <div class="alert alert-info text-center" role="alert">
            You have hidden all dashboard cards. Update your <a href="{{ url_for('main.settings') }}" class="alert-link">settings</a> to select the data you want to see.
          </div>
        </div>
        {% endif %}
      </div>
    </main>

    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1200">
      <div
        id="refresh-toast"
        class="toast refresh-toast fade"
        role="status"
        aria-live="assertive"
        aria-atomic="true"
        data-bs-delay="3000"
      >
        <div class="toast-body">
          <div class="me-3">
            <span id="refresh-toast-label" class="toast-label d-block">Status</span>
            <span id="refresh-toast-message" class="small">Ready</span>
          </div>
          <button
            type="button"
            class="btn-close btn-close-white ms-auto"
            data-bs-dismiss="toast"
            aria-label="Close"
          ></button>
        </div>
      </div>
    </div>

    <footer class="bg-dark text-white-50 py-3">
      <div class="container text-center small">
        &copy; API Dashboard Â· Built with Flask &amp; Bootstrap
      </div>
    </footer>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const rootEl = document.body;
        const autoRefreshIntervalMinutes = Number(rootEl?.dataset?.autoRefreshInterval || "5");
        const AUTO_REFRESH_INTERVAL_MS = Math.max(autoRefreshIntervalMinutes || 5, 1) * 60 * 1000;
        const buttons = document.querySelectorAll("[data-refresh-endpoint]");
        const refreshOrder = ["crypto", "weather", "news"];

        const { Toast: BootstrapToast } = window.bootstrap || {};
        const toastEl = document.getElementById("refresh-toast");
        const toastLabelEl = document.getElementById("refresh-toast-label");
        const toastMessageEl = document.getElementById("refresh-toast-message");
        const toastInstance =
          toastEl && BootstrapToast
            ? BootstrapToast.getOrCreateInstance(toastEl, {
                animation: true,
                autohide: true,
                delay: 3000,
              })
            : null;
        const toastVariants = {
          crypto: { className: "toast-crypto", label: "Crypto" },
          weather: { className: "toast-weather", label: "Weather" },
          news: { className: "toast-news", label: "News" },
          error: { className: "toast-error", label: "Refresh Failed" },
        };
        const toastVariantClasses = Object.values(toastVariants).map(
          (item) => item.className
        );

        const showRefreshToast = (variant, message) => {
          if (!toastInstance || !toastEl || !toastMessageEl) return;
          const config = toastVariants[variant] || toastVariants.error;
          toastEl.classList.remove(...toastVariantClasses);
          if (config?.className) {
            toastEl.classList.add(config.className);
          }
          if (toastLabelEl && config?.label) {
            toastLabelEl.textContent = config.label;
          }
          toastMessageEl.textContent = message || "Updated";

          if (toastEl.classList.contains("show")) {
            toastEl.addEventListener(
              "hidden.bs.toast",
              () => {
                toastInstance.show();
              },
              { once: true }
            );
            toastInstance.hide();
          } else {
            toastInstance.show();
          }
        };

        const setRefreshingState = (card, isRefreshing) => {
          if (!card) return;
          card.classList.toggle("is-refreshing", isRefreshing);
          const overlay = card.querySelector(".card-refresh-overlay");
          if (overlay) {
            overlay.classList.toggle("show", isRefreshing);
          }
        };

        const triggerCardFlash = (card, variant) => {
          if (!card) return;
          const className = variant === "success" ? "flash-success" : "flash-error";
          card.classList.remove("flash-success", "flash-error");
          void card.offsetWidth;
          card.classList.add(className);
          window.setTimeout(() => {
            card.classList.remove(className);
          }, 900);
        };

        const animateTimestamp = (element) => {
          if (!element) return;
          element.classList.remove("timestamp-flash");
          void element.offsetWidth;
          element.classList.add("timestamp-flash");
        };

        const successMessages = {
          crypto: "Crypto data refreshed",
          weather: "Weather forecast updated",
          news: "News headlines refreshed",
        };

        const failureMessages = {
          crypto: "Unable to refresh crypto right now.",
          weather: "Unable to refresh weather right now.",
          news: "Unable to refresh news right now.",
        };

        const formatCurrency = (value) =>
          new Intl.NumberFormat("en-US", {
            style: "currency",
            currency: "USD",
            maximumFractionDigits: 2,
          }).format(value);

        const formatTimestamp = (value) => {
          const date = value ? new Date(value) : new Date();
          const safeDate = Number.isNaN(date.getTime()) ? new Date() : date;
          return new Intl.DateTimeFormat("en-US", {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            hour12: false,
            timeZoneName: "short",
          }).format(safeDate);
        };

        const updaters = {
          crypto: (payload) => {
            const btcPriceEl = document.getElementById("crypto-price-btc");
            const ethPriceEl = document.getElementById("crypto-price-eth");
            const updatedEl = document.getElementById("crypto-last-updated");
            const btc = payload?.bitcoin?.usd;
            const eth = payload?.ethereum?.usd;

            if (btcPriceEl) {
              btcPriceEl.textContent =
                typeof btc === "number" ? formatCurrency(btc) : "N/A";
            }
            if (ethPriceEl) {
              ethPriceEl.textContent =
                typeof eth === "number" ? formatCurrency(eth) : "N/A";
            }
            if (updatedEl) {
              const timestamp =
                payload?.last_updated || new Date().toISOString();
              updatedEl.textContent = `Last updated ${formatTimestamp(timestamp)}`;
              animateTimestamp(updatedEl);
            }
          },
          weather: (payload) => {
            const cityEl = document.getElementById("weather-city");
            const tempEl = document.getElementById("weather-temperature");
            const conditionEl = document.getElementById("weather-condition");
            const humidityEl = document.getElementById("weather-humidity");
            const windEl = document.getElementById("weather-wind");
            const updatedEl = document.getElementById("weather-last-updated");

            const temperature = payload?.temperature;
            const condition = payload?.condition;
            const humidity = payload?.humidity;
            const windSpeed = payload?.wind_speed;
            const city = payload?.city;

            if (cityEl && city) {
              cityEl.textContent = city;
            }

            if (tempEl) {
              tempEl.textContent =
                typeof temperature === "number"
                  ? `${Math.round(temperature)}${String.fromCharCode(176)}F`
                  : "N/A";
            }

            if (conditionEl) {
              const formattedCondition = (() => {
                if (!condition) return "";
                const text = String(condition).trim();
                return text
                  .split(" ")
                  .map((word) =>
                    word
                      ? word[0].toUpperCase() + word.slice(1).toLowerCase()
                      : ""
                  )
                  .join(" ");
              })();
              conditionEl.textContent =
                formattedCondition || "Condition unavailable";
            }

            if (humidityEl) {
              humidityEl.textContent =
                typeof humidity === "number"
                  ? `Humidity: ${humidity}%`
                  : "Humidity: N/A";
            }

            if (windEl) {
              windEl.textContent =
                typeof windSpeed === "number"
                  ? `Wind: ${windSpeed.toFixed(1)} mph`
                  : "Wind: N/A";
            }

            if (updatedEl) {
              const timestamp =
                payload?.last_updated || new Date().toISOString();
              updatedEl.textContent = `Last updated ${formatTimestamp(timestamp)}`;
              animateTimestamp(updatedEl);
            }
          },
          news: (payload) => {
            const listEl = document.getElementById("news-headlines");
            const emptyStateEl = document.getElementById("news-empty-state");
            const updatedEl = document.getElementById("news-last-updated");
            const headlines = Array.isArray(payload?.headlines)
              ? payload.headlines.slice(0, 5)
              : [];

            if (updatedEl) {
              const timestamp =
                payload?.last_updated || new Date().toISOString();
              const suffix = headlines.length ? "" : " (no headlines available)";
              updatedEl.textContent = `Last updated ${formatTimestamp(
                timestamp
              )}${suffix}`;
              animateTimestamp(updatedEl);
            }

            if (listEl) {
              listEl.innerHTML = "";
            }

            if (headlines.length && listEl) {
              headlines.forEach((item) => {
                if (!item?.url) return;

                const li = document.createElement("li");
                li.className = "news-headline-item";

                const link = document.createElement("a");
                link.className = "news-headline-link";
                link.href = item.url;
                link.target = "_blank";
                link.rel = "noopener noreferrer";
                link.textContent = item.title || "Read more";

                li.appendChild(link);

                if (item.source) {
                  const sourceEl = document.createElement("div");
                  sourceEl.className = "news-headline-meta";
                  sourceEl.textContent = item.source;
                  li.appendChild(sourceEl);
                }

                if (item.description) {
                  const descEl = document.createElement("p");
                  descEl.className = "news-headline-description mb-0";
                  descEl.textContent = item.description;
                  li.appendChild(descEl);
                }

                listEl.appendChild(li);
              });

              listEl.classList.remove("d-none");
              if (emptyStateEl) {
                emptyStateEl.classList.add("d-none");
                emptyStateEl.textContent =
                  "No headlines available right now. Try refreshing in a moment.";
              }
            } else {
              if (listEl) {
                listEl.classList.add("d-none");
                listEl.innerHTML = "";
              }
              if (emptyStateEl) {
                emptyStateEl.classList.remove("d-none");
                emptyStateEl.textContent =
                  "No headlines available right now. Try refreshing in a moment.";
              }
            }
          },
        };

        const refreshTargets = {};
        const refreshLocks = {};

        const handleRefreshFailure = (type) => {
          const updatedElementId =
            type === "crypto"
              ? "crypto-last-updated"
              : type === "weather"
              ? "weather-last-updated"
              : type === "news"
              ? "news-last-updated"
              : "";
          if (updatedElementId) {
            const updatedEl = document.getElementById(updatedElementId);
            if (updatedEl) {
              updatedEl.textContent =
                "Last updated: unable to refresh at this time.";
            }
          }

          if (type === "news") {
            const listEl = document.getElementById("news-headlines");
            const emptyStateEl = document.getElementById("news-empty-state");
            if (listEl) {
              listEl.classList.add("d-none");
              listEl.innerHTML = "";
            }
            if (emptyStateEl) {
              emptyStateEl.classList.remove("d-none");
              emptyStateEl.textContent =
                "Unable to load headlines right now. Please try again soon.";
            }
          }
        };

        const performRefresh = async (type, options = {}) => {
          const target = refreshTargets[type];
          if (!target || refreshLocks[type]) return;
          const { button, endpoint, card } = target;
          if (!endpoint) return;

          refreshLocks[type] = true;
          if (button) {
            button.disabled = true;
            button.classList.add("disabled");
          }
          setRefreshingState(card, true);

          try {
            const response = await fetch(endpoint, { cache: "no-store" });
            if (!response.ok) {
              throw new Error(`Request failed: ${response.status}`);
            }
            const payload = await response.json();
            updaters[type](payload);
            triggerCardFlash(card, "success");
            if (!options.silentSuccess) {
              const successMessage = successMessages[type] || "Refresh complete";
              const variant = successMessages[type] ? type : "crypto";
              showRefreshToast(variant, successMessage);
            }
          } catch (error) {
            console.error(`Failed to refresh ${type} data:`, error);
            handleRefreshFailure(type);
            triggerCardFlash(card, "error");
            if (!options.silentFailure) {
              const failureMessage = failureMessages[type] || "Refresh failed.";
              showRefreshToast("error", failureMessage);
            }
          } finally {
            setRefreshingState(card, false);
            if (button) {
              button.disabled = false;
              button.classList.remove("disabled");
            }
            refreshLocks[type] = false;
          }
        };

        buttons.forEach((button) => {
          const endpoint = button.dataset.refreshEndpoint;
          const type = button.dataset.refreshType;
          if (!endpoint || !type || !(type in updaters)) return;
          const card = button.closest(".card-section");

          refreshTargets[type] = { button, endpoint, card };

          button.addEventListener("click", () => {
            performRefresh(type, { source: "manual" });
          });
        });

        const autoRefreshToggle = document.getElementById("auto-refresh-toggle");
        let autoRefreshIntervalId = null;
        let autoRefreshCycleInFlight = false;

        const stopAutoRefresh = () => {
          if (autoRefreshIntervalId) {
            window.clearInterval(autoRefreshIntervalId);
            autoRefreshIntervalId = null;
          }
        };

        const autoRefreshCycle = async () => {
          if (autoRefreshCycleInFlight) return;
          autoRefreshCycleInFlight = true;
          try {
            for (const type of refreshOrder) {
              if (!refreshTargets[type]) continue;
              await performRefresh(type, { source: "auto" });
            }
          } finally {
            autoRefreshCycleInFlight = false;
          }
        };

        const startAutoRefresh = () => {
          stopAutoRefresh();
          if (!refreshOrder.some((type) => refreshTargets[type])) {
            return;
          }
          autoRefreshCycle();
          autoRefreshIntervalId = window.setInterval(
            autoRefreshCycle,
            AUTO_REFRESH_INTERVAL_MS
          );
        };

        if (autoRefreshToggle) {
          autoRefreshToggle.addEventListener("change", (event) => {
            const enabled = event.target.checked;
            if (enabled) {
              startAutoRefresh();
            } else {
              stopAutoRefresh();
            }
          });

          if (autoRefreshToggle.checked) {
            startAutoRefresh();
          }
        }
      });
    </script>
  </body>
</html>








